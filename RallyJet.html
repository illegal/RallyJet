<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>RallyJet</title>

    <meta name="Name" content="RallyJet"/>
    <meta name="Version" content="1.0"/>
    <meta name="Vendor" content="Vitalii Tiutiunnyk"/>

    <!--<script type="text/javascript" src="/apps/1.29/sdk.js"></script>-->
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/1.29/sdk.js?debug=true"></script>
    <script type="text/javascript">

        function ExtendedTable(tableConfig, rallyDataSource, domElementId, rallyObjectTypes) {
            var USER_STORY_OBJECT_TYPE_NAME = 'hierarchicalrequirement';
            var GENERIC_STATE_ATTRIBUTE_NAME = 'State';
            var USER_STORY_STATE_ATTRIBUTE_NAME = 'ScheduleState';

            var config = tableConfig;
            var dataSource = rallyDataSource;
            var domElementBound = domElementId;
            var objectTypes = rallyObjectTypes;
            var table = new rally.sdk.ui.Table(config);
            var self = this;

            function getObjectAttributes(objectType) {
                var attributesToFetch = [];
                for (var i = 0; i < config.columns.length; i++) {
                    var column = config.columns[i];
                    if (column.key === GENERIC_STATE_ATTRIBUTE_NAME && objectType === USER_STORY_OBJECT_TYPE_NAME) {
                        attributesToFetch[i] = USER_STORY_STATE_ATTRIBUTE_NAME;
                    } else {
                        attributesToFetch[i] = column.key;
                    }
                }

                return attributesToFetch;
            }

            function prepareQueryConfiguration(filterQuery) {
                var queryConfigArray = [];

                for (var i = 0; i < objectTypes.length; i++) {
                    queryConfigArray[i] = {
                        type: objectTypes[i],
                        key: objectTypes[i],
                        query: filterQuery,
                        fetch: getObjectAttributes(objectTypes[i]).join(',')
                    };
                }

                return queryConfigArray;
            }

            function onLoadObjectsComplete(results) {
                var rows = [];
                var index = 0;

                for (var i = 0; i < objectTypes.length; i++) {
                    var objectType = objectTypes[i];
                    var objectAttributes = getObjectAttributes(objectType);
                    for (var j = 0; j < results[objectType].length; j++) {
                        var resultItem = results[objectType][j];
                        var row = {};
                        for (var k = 0; k < objectAttributes.length; k++) {
                            var attributeName = objectAttributes[k];
                            row[attributeName] = resultItem[attributeName];
                        }
                        rows[index++] = row;
                    }
                }

                table.addRows(rows);
                table.display(domElementBound);
            }

            this.loadObjects = function(filterQuery) {
                dataSource.findAll(prepareQueryConfiguration(filterQuery), onLoadObjectsComplete);
            };
        }

        function ExtendedIterationDropdown(rallyDataSource, domElementId, onChanged) {
            var UNSCHEDULED_ITERATION_ID = 'NULL_CRITERIA';

            var dataSource = rallyDataSource;
            var domElementBound = domElementId;
            var onSelectionChanged = onChanged;
            var dropdown = new rally.sdk.ui.basic.Dropdown({ label: "Select an iteration : " });
            var items = [];
            var self = this;

            function onLoadIterationsComplete(results) {
                var now = new Date();
                var currentIterationId = UNSCHEDULED_ITERATION_ID;
                items[0] = { label: 'Unscheduled', value: UNSCHEDULED_ITERATION_ID };
                for (var i = 0; i < results.iterations.length; i++) {
                    var iteration = results.iterations[i];
                    items[i + 1] = { label: iteration.Name, value: iteration.ObjectID };
                    if (currentIterationId === UNSCHEDULED_ITERATION_ID
                            && now >= rally.sdk.util.DateTime.fromIsoString(iteration.StartDate, true)
                            && now <= rally.sdk.util.DateTime.fromIsoString(iteration.EndDate, true)) {

                        currentIterationId = iteration.ObjectID;
                    }
                }

                dropdown.setItems(items);
                self.display();
                dropdown.setValue(currentIterationId);
            };

            this.loadIterations = function() {
                dataSource.findAll({
                    type: 'iteration',
                    key: 'iterations',
                    fetch: 'Name,ObjectID,StartDate,EndDate',
                    order: 'StartDate desc'
                }, onLoadIterationsComplete);
            };

            this.isUnscheduledIteration = function() {
                return dropdown.getValue() === UNSCHEDULED_ITERATION_ID;
            };

            this.getIterationId = function() {
                return dropdown.getValue();
            };

            this.display = function() {
                dropdown.display(domElementBound, onSelectionChanged);
            };
        }

        function RallyJetApp() {
//            var rallyDataSource = new rally.sdk.data.RallyDataSource("__WORKSPACE_OID__",
//                    "__PROJECT_OID__",
//                    "__PROJECT_SCOPING_UP__",
//                    "__PROJECT_SCOPING_DOWN__");

            var rallyDataSource = new rally.sdk.data.RallyDataSource('2541145153',
                    '4098172609',
                    false,
                    false);

            function onIterationChanged() {
                var filterQuery = '';
                if (!iterationDropdown.isUnscheduledIteration()) {
                    filterQuery = '(Iteration.ObjectID = ' + iterationDropdown.getIterationId() + ')';
                }
                defectsAndStoriesTable.loadObjects(filterQuery);
            };

            var iterationDropdown = new ExtendedIterationDropdown(rallyDataSource,
                    "iterationDropdown",
                    onIterationChanged);

            var defectsAndStoriesTable = new ExtendedTable(
                    {
                        columns: [
                            { key: 'FormattedID', header: 'ID' },
                            { key: 'Name', header: 'Name' },
                            { key: 'ScheduleState', header: 'State' }
                        ]
                    },
                    rallyDataSource,
                    "defectsAndStoriesTable",
                    ['defect', 'hierarchicalrequirement']);

            this.start = function() {
                iterationDropdown.loadIterations();
            };

            this.getRallyDataSource = function() {
                return rallyDataSource;
            };

            this.getIterationDropdown = function() {
                return iterationDropdown;
            };
        }

        function onLoad() {
            var rallyJetApp = new RallyJetApp();
            rallyJetApp.start();
        }

        rally.addOnLoad(onLoad);
    </script>
</head>
<body>
    <div id="iterationDropdown"></div>
    <div id="defectsAndStoriesTable"></div>
</body>
</html>